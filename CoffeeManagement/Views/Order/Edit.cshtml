@model Order

@{
    ViewData["Title"] = "Chỉnh sửa bán hàng";
    var paymentMethod = new List<SelectListItem>
    {
        new SelectListItem { Value = "cash", Text = "Tiền mặt" },
        new SelectListItem { Value = "card", Text = "Thẻ" },
        new SelectListItem { Value = "mobile", Text = "Chuyển khoản" }
    };
}
@section Links {
    <link rel="stylesheet" href="~/assets/css/course.css">
    <link rel="stylesheet" href="~/assets/css/checkbox.css">
    <style>
        .form-group {
            display: flex;
            flex-direction: column;
        }
    </style>
}

<div class="container">
    <div class="table-container m-4">
        <h4 class="text-center mb-4 mt-2 text-danger" style="font-size:30px;font-weight:bold;">CHỈNH SỬA BÁN HÀNG</h4>
        <form asp-action="Edit" asp-controller="Purchase" method="post" id="form-edit" class="container">
            @Html.HiddenFor(x => x.Id)
            <input type="hidden" name="PurchasedNo" value="@Model.SaleNo" />
            <div class="row info-detail">
                <div class="col-lg-4">
                    <div class="form-group mb-3">
                        <span class="text-no-wrap">Số Mua hàng</span>
                        <input class="form-control" value="@Model.SaleNo" disabled />
                    </div>
                    <div class="form-group mb-3">
                        <span class="text-no-wrap">Khách hàng</span>
                        @Html.DropDownListFor(x => x.CustomerId, (IEnumerable<SelectListItem>)ViewBag.Customers, " Khách vãng lai ", new { @class = "form-control" })
                    </div>
                    <div class="form-group mb-3">
                        <span class="text-no-wrap">Số Hóa đơn</span>
                        <input asp-for="BillNo" class="form-control" />
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="IsUsing" name="IsUsing" @(Model.IsUsing == true ? "checked" : "")>
                        <label class="form-check-label" for="checkDefault">
                            Đang dùng
                        </label>
                    </div>
                    <!-- Active TakeHome Toggle -->
                    <div class="mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="IsTakeHome" @(Model.IsTakeHome == true ? "checked" : "") />
                            <label class="form-check-label" for="IsTakeHome">Mang về</label>
                        </div>
                    </div>
                    
                </div>
                <div class="col-lg-4">
                    <div class="form-group mb-3">
                        <span class="text-no-wrap">Ngày bán hàng</span>
                        <input asp-for="SaleDate" type="datetime-local" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <span class="text-no-wrap">Ngày thanh toán</span>
                        <input asp-for="PaymentDate" type="datetime-local" class="form-control" />
                    </div>
                    <div class="form-group mb-3">
                        <span class="text-no-wrap">Phương thức thanh toán</span>
                        @Html.DropDownListFor(x => x.PaymentMethod, paymentMethod, "Chưa thanh toán", new { @class = "form-control" })
                    </div>
                    <!-- Table Selection -->
                    <div class="mb-3 toggle-table-select">
                        <label for="tableSelect" class="form-label">Table</label>
                        <select asp-items="ViewBag.Tables" asp-for="TableId" class="form-select">
                            <option value="">Chọn sau</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="form-group mb-3 form-account">
                        <label style="font-size:30px;" class="text-danger">Tổng thành tiền</label>
                        <b style="font-size:30px;" class="text-success" id="TotalAmount">@Model.TotalAmount.ToString("N0")</b>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="Description" class="form-label">Ghi chú</label>
                        <textarea asp-for="Description" class="form-control"></textarea>
                    </div>
                    
                    
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12 table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead>
                            <tr class="table-primary">
                                <th>STT</th>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn vị</th>
                                <th>Đơn giá</th>
                                <th>Giảm giá (%)</th>
                                <th>Thành tiền</th>
                                <th>Ghi chú</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbody-list">
                            @if (Model.OrderDetails != null && Model.OrderDetails.Any())
                            {
                                int stt = 1;
                                foreach (var item in Model.OrderDetails)
                                {
                                    <tr>
                                        <td>@stt</td>
                                        <td>
                                            @Html.DropDownList("Product", new SelectList(ViewBag.Products, "Id", "Name", item.ProductId), "-- Chọn sản phẩm --", new { @class = "ItemId form-control", required = "required" })
                                        </td>
                                        <td><input type="number" class="Quantity form-control" min="1" value="@item.Quantity" required /></td>
                                        <td class="Unit">@item.Product?.Unit</td>
                                        <td><input type="number" class="UnitPrice form-control" min="0" value="@item.UnitPrice" required  /></td>
                                        <td><input type="number" class="Discount form-control" min="0" max="100" value="@item.Discount" /></td>
                                        <td class="text-center text-no-wrap"><b class="TotalPrice">0</b> VND</td>
                                        <td><input type="text" class="Description form-control" value="@item.Description" /></td>
                                        <td><button onclick="deleteRow(this)" type="button" class="btn btn-danger">Xóa</button></td>
                                    </tr>
                                    stt++;
                                }
                            }
                        </tbody>
                        <tfoot>
                            <tr class="table-warning">
                                <td colspan="6" class="text-lg-end">Tổng thành tiền</td>
                                <td class="text-center text-no-wrap">
                                    <b class="SumTotalPrice">0</b> VND
                                </td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    <button id="btn-add-row" class="btn btn-primary" type="button">Thêm hàng</button>
                </div>
            </div>

            <div class="mt-3 text-lg-end">
                <a asp-action="Index" class="btn btn-outline-secondary">Quay lại</a>
                <button id="btn-save" type="submit" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    <script>
        var rowContent = `<tr>
                                        <td>1</td>
                                        <td>
        @(Html.DropDownList("Product", new SelectList(ViewBag.Products, "Id", "Name"), "-- Chọn sản phẩm --", new { @class = "ItemId form-control", required = "required" }))
                                        </td>
                                        <td><input type="number" class="Quantity form-control" min="1" value="1" required /></td>
                                        <td class="Unit"></td>
                                        <td><input type="number" class="UnitPrice form-control" min="0" value="0" required /></td>
                                        <td><input type="number" class="Discount form-control" min="0" max="100" value="0" /></td>
                                        <td class="text-center text-no-wrap"><b class="TotalPrice">0</b> VND</td>
                                        <td><input type="text" class="Description form-control" value="" /></td>
                                        <td><button onclick="deleteRow(this)" type="button" class="btn btn-danger">Xóa</button></td>
                                    </tr>`;

        $(document).ready(function () {

            $('form').submit(function (event) {
                event.preventDefault();
                $('#btn-save').attr("disabled", true);
                var data = {
                    Id: '@Model.Id',
                    PurchasedNo: $('#SaleNo').val(),
                    CustomerId: $('#CustomerId').val(),
                    BillNo: $('#BillNo').val(),
                    SaleDate: $('#SaleDate').val(),
                    PaymentDate: $('#PaymentDate').val(),
                    CustomerName: $('#CustomerId option:selected').text(),
                    PaymentMethod: $('#PaymentMethod').val(),
                    Description: $('#Description').val(),
                    TotalAmount: $('#TotalAmount').text().replaceAll(',', ''),
                    TableId: $('#TableId').val(),
                    OrderDetails: []
                }

                $('#tbody-list tr').each(function (index, tr) {
                    var objectItem = {
                        ProductId: $(tr).find('.ItemId').val(),
                        ProductName: $(tr).find('.ItemId option:selected').text(),
                        Quantity: $(tr).find('.Quantity').val(),
                        UnitPrice: $(tr).find('.UnitPrice').val(),
                        Discount: $(tr).find('.Discount').val() || 0,
                        Description: $(tr).find('.Description').val()
                    }

                    if (objectItem.ProductId && objectItem.Quantity && objectItem.UnitPrice) {
                        data.OrderDetails.push(objectItem);
                    }
                });
                console.log(data);
                $.ajax({
                    url: '@Url.Action("Edit", "Order")',
                    method: 'post',
                    data: data,
                    success: function (response) {
                        if (response.success) {
                            showAlert("success", "Cập nhật thành công");
                            setTimeout(function () {
                                window.location.href = response.redirect;
                            }, 1500);
                        } else {
                            showAlert("error", response.error);
                        }
                        $('#btn-edit').removeAttr("disabled");
                    },
                    error: function (error) {
                        console.log(error);
                        showAlert("error", "Có lỗi xảy ra khi gửi yêu cầu.");
                        $('#btn-edit').removeAttr("disabled");
                    },
                    complete: function () {
                        $('#btn-edit').removeAttr("disabled");
                    }
                });
            });

            $('#btn-add-row').on('click', () => {
                $('#tbody-list').append(rowContent);
                $('#tbody-list tr').each(function (index) {
                    $(this).find('td:first').text(index + 1);
                });
            });
        });

        $(document).on('change', '.ItemId', function () {
            var selectedItemId = $(this).val();
            var unit = '';
            var price = '';
            @foreach (var item in ViewBag.Products)
            {
                <text>
                    if (selectedItemId == '@item.Id') {
                        unit = '@Html.Raw(item.Unit)';
                        price = @item.Price;
                    }
                </text>
            }

            $(this).closest('tr').find('.Unit').text(unit);
            $(this).closest('tr').find('.UnitPrice').val(price);
            var row = $(this).closest('tr');
            calculateTotalPrice(row);
        });

        function calculateTotalPrice(row) {
            var quantity = parseFloat($(row).find('.Quantity').val()) || 0;
            var unitPrice = parseFloat($(row).find('.UnitPrice').val()) || 0;
            var discount = parseFloat($(row).find('.Discount').val()) || 0;

            var totalPrice = quantity * unitPrice * (1 - discount / 100);
            $(row).find('.TotalPrice').text(formatCurrencyVN(totalPrice.toFixed(2)));
            calculateSumTotalPrice();
        }

        function calculateSumTotalPrice() {
            var sumTotal = 0;

            $('#tbody-list tr').each(function () {
                var totalPrice = parseFloat($(this).find('.TotalPrice').text().replaceAll(',', '')) || 0;
                sumTotal += totalPrice;
            });

            $('.SumTotalPrice').text(formatCurrencyVN(sumTotal.toFixed(2)));
            $('#TotalAmount').text(formatCurrencyVN(sumTotal.toFixed(2)));
        }

        $(document).on('input', '.Quantity, .UnitPrice, .Discount', function () {
            var row = $(this).closest('tr');
            calculateTotalPrice(row);
        });
        $('.Quantity').trigger('input');

        const takeHome = $("#IsTakeHome").is(':checked');
            if(takeHome) {
                $('#IsTakeHome').prop('checked', true);
                $('#TableId').prop('disabled', true);
                $('#TableId').val(null);
            } 
            // Disabled Table Select While check TakeHome checkbox
            $('#IsTakeHome').on('change', function () {
                if ($(this).is(':checked')) {
                    $('#TableId').prop('disabled', true);
                    $('#TableId').val(null);
                } else {
                    $('#TableId').prop('disabled', false);
                }
            });



        function deleteRow(element) {
            var count = $('#tbody-list tr').length;
            if (count > 1) {
                $(element).closest('tr').remove();
                $('.Quantity').trigger('input');
                $('#tbody-list tr').each(function (index) {
                    $(this).find('td:first').text(index + 1);
                });
            }
        }

        function formatCurrencyVN(value) {
            if (isNaN(value)) return '0';
            let num = parseFloat(value).toFixed(2);
            let parts = num.split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts[1] === "00" ? parts[0] : parts.join(".");
        }
    </script>

}
