@{
    ViewData["Title"] = "Danh sách mua hàng";
}

@section Links {
    <link rel="stylesheet" href="~/assets/css/course.css">
}

<div class="container">
    <div class="table-container m-4 table-responsive">
        <h4 class="text-center mb-4 mt-2 text-danger" style="font-size:30px;font-weight:bold;">DANH SÁCH MUA HÀNG</h4>
        <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
            <a asp-action="Create" asp-controller="Purchase" class="btn btn-add-course">+ Thêm mua hàng</a>
        </div>

        <!-- Table to display employee data using DataTable -->
        <table id="tableData" class="table table-striped">
            <thead class="table-primary">
                <tr class="table-primary">
                    <th>ID</th>
                    <th>Số MH</th>
                    <th>Số Hóa đơn</th>
                    <th>Ngày mua</th>
                    <th>Nhà cung cấp</th>
                    <th>Nhân viên</th>
                    <th>Tổng tiền</th>
                    <th>Ghi chú</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded dynamically by DataTable -->
            </tbody>
        </table>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p><strong>Bạn có chắc chắn muốn xóa phiếu mua sau không?</strong></p>
                <ul id="purchaseInfo" class="list-unstyled mb-0"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {

    <script>
        var table = $('#tableData').DataTable({
            "processing": true,
            "serverSide": true,
            "searching": true,  // Enable the default search box of DataTable
            "ajax": {
                "url": '@Url.Action("_GetList", "Purchase")', // AJAX call to _GetList action
                "data": function (d) {
                    d.keyword = $('input[type="search"]').val(); // Pass the search keyword to the server
                },
                "type": "POST",
                "dataSrc": function (json) {
                    return json.data; // Đảm bảo dữ liệu trả về theo đúng định dạng DataTable yêu cầu
                }
            },
            "pageLength": 25, // Default page size
            "lengthMenu": [10, 25, 50, 100], // Options for page size
            "columns": [
                { "data": "Id" },
                { "data": "PurchasedNo" },
                { "data": "BillNo" },
                { "data": "PurchasedDateStr" },
                { "data": "SupplierName" },
                { "data": "EmployeeName" },
                {
                    "data": "TotalAmount",
                    "render": function (data, type, row) {
                        // Định dạng giá tiền (nếu cần)
                        return data ? data.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) : '';
                    }
                },
                { "data": "Description" },
                {
                    "data": "Id",
                    "render": function (data, type, row) {
                        // Create the "Edit" button with dynamic link
                        return `
                                        <a href="/Purchase/Edit/` + data + `" class="btn btn-outline-primary"><i class="bi bi-pencil-fill"></i></a>
                                        <button onclick="deleteRow(`+ data + `)" class="btn-delete btn btn-danger"><i class="bi bi-trash-fill"></i></a>
                                    `;
                    }
                }
            ]
        });

        let selectedId = null;

        async function deleteRow(id) {
            if (!id) return;

            // Gọi API để lấy thông tin ngắn gọn
            $.post('@Url.Action("GetShortInfor", "Purchase")', { id: id }, function (response) {
                if (response.success) {
                    selectedId = id;
                    const data = response.data;
                    const infoHtml = `
                        <li><strong>ID:</strong> ${data.Id}</li>
                        <li><strong>Số MH:</strong> ${data.PurchasedNo}</li>
                        <li><strong>Nhà cung cấp:</strong> ${data.SupplierName ?? 'Không có'}</li>
                        <li><strong>Nhân viên:</strong> ${data.EmployeeName}</li>
                        <li><strong>Ngày mua:</strong> ${data.PurchasedDateStr}</li>
                        <li><strong>Tổng tiền:</strong> ${data.TotalAmountStr ?? '0'}</li>
                        <li><strong>Ghi chú:</strong> ${data.Description ?? ''}</li>
                    `;
                    $('#purchaseInfo').html(infoHtml);
                    var modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                    modal.show();
                } else {
                    showAlert("error", "Không tìm thấy", response.error);
                }
            });
        }

        // Khi người dùng nhấn xác nhận xóa
        $('#confirmDeleteBtn').on('click', function () {
            if (!selectedId) return;

            $.ajax({
                url: '@Url.Action("Delete", "Purchase")',
                method: 'post',
                data: { id: selectedId },
                success: function (response) {
                    if (response.success) {
                        $('#deleteConfirmModal').modal('hide');
                        showAlert("success", "Thành công", response.message);
                        table.ajax.reload(null, false);
                    } else {
                        showAlert("error", "Lỗi", response.message);
                    }
                },
                error: function (error) {
                    showAlert("error", "Lỗi", error.statusText);
                }
            });
        });





    </script>
}
